#!/usr/bin/env node

/**
 * Capture Prisma Query Logs for Evidence
 *
 * This script demonstrates the actual SQL queries generated
 * and shows the difference between optimized and unoptimized patterns
 */

import dotenv from "dotenv";
dotenv.config({ path: ".env.local" });

// Enable Prisma query logging
process.env.DEBUG = "prisma:query";

import {
  getUsersUnoptimized,
  getUsersOptimized,
  getTasksWithCommentsUnoptimized,
  getTasksWithCommentsOptimized,
  cleanup,
} from "../lib/tasks/optimized-queries.js";

const colors = {
  reset: "\x1b[0m",
  green: "\x1b[32m",
  red: "\x1b[31m",
  yellow: "\x1b[33m",
  cyan: "\x1b[36m",
  bold: "\x1b[1m",
};

function log(message, color = "reset") {
  console.log(`${colors[color]}${message}${colors.reset}`);
}

async function captureQueryLogs() {
  log("\nüìã Capturing SQL Query Logs for Evidence", "bold");
  log("=".repeat(70), "cyan");

  log("\n‚ùå UNOPTIMIZED: Fetching all user fields", "red");
  log("-".repeat(70), "cyan");
  await getUsersUnoptimized();

  log("\n‚úÖ OPTIMIZED: Selective field fetching", "green");
  log("-".repeat(70), "cyan");
  await getUsersOptimized();

  log("\n‚ùå UNOPTIMIZED: N+1 Query Problem", "red");
  log("-".repeat(70), "cyan");
  await getTasksWithCommentsUnoptimized();

  log("\n‚úÖ OPTIMIZED: Single query with JOIN", "green");
  log("-".repeat(70), "cyan");
  await getTasksWithCommentsOptimized();

  await cleanup();

  log("\n‚úÖ Query log capture complete!", "green");
  log("\nNote: Check the prisma:query output above to see:", "cyan");
  log("  ‚Ä¢ SQL queries generated by Prisma", "cyan");
  log("  ‚Ä¢ Query execution times", "cyan");
  log("  ‚Ä¢ Index usage (EXPLAIN ANALYZE)", "cyan");
  log("\n");
}

captureQueryLogs();
